	<!DOCTYPE html>
	<html lang="en">

	<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="description" content="">
	<meta name="author" content="">

	<title>San Francisco Crime Map</title>

	<!--Libraries -->
	<script src="http://cdn.leafletjs.com/leaflet-0.7.5/leaflet.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.6/d3.min.js" charset="utf-8"></script>
	<script src="http://d3js.org/queue.v1.min.js"></script>

	<!-- Stylesheets -->
	<link href="css/bootstrap.css" rel="stylesheet">
	<link href="css/customized.css" rel="stylesheet">
	<link href="http://cdn.leafletjs.com/leaflet-0.7.5/leaflet.css"  rel="stylesheet">
	</head>

	<body>

	<!-- Navigation -->
	<nav class="navbar navbar-inverse navbar-static-top" role="navigation">
		<div class="container">
			<!-- Brand and toggle get grouped for better mobile display -->
			<div class="navbar-header">
				<button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
					<span class="sr-only">Toggle navigation</span>
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
				</button>
				<a class="navbar-brand" href="#">San Francisco Crime Map</a>
			</div>
			<!-- Collect the nav links, forms, and other content for toggling -->
			<div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
				<ul class="nav navbar-nav pull-right">
					<li>
						<a href="#">Map</a>
					</li>
					<li>
						<a href="#">Charts</a>
					</li>
					<li>
						<a href="#">Stories</a>
					</li>
					<li>
						<a href="#">About</a>
					</li>
				</ul>
			</div>
			<!-- /.navbar-collapse -->
		</div>
		<!-- /.container -->
	</nav>

	<!-- Page Content -->
	<div class="container">
		<div class="row">
			<div class="col-xs-2" style="height:450px">
				<form role="form">
					<div class="row"><span>Crime Type</span></div>
					<div class="checkbox">
						<label>
							<input type="checkbox" value="assault"> Assault
						</label>
					</div>
					<div class="checkbox">
						<label>
							<input type="checkbox" value="burglary"> Burglary
						</label>
					</div>
					<div class="checkbox">
						<label>
							<input type="checkbox" value="drug"> Drug/Narcotics
						</label>
					</div>
					<div class="checkbox">
						<label>
							<input type="checkbox" value="homicide" onclick="update_checkbox(this.checked, value)" checked> Homicide
						</label>
					</div>
					<div class="checkbox">
						<label>
							<input type="checkbox" value="robbery"> Robbery
						</label>
					</div>
					<div class="checkbox">
						<label>
							<input type="checkbox" value="sexOffense" onclick="update_checkbox(this.checked, value)"> Sex Offenses
						</label>
					</div>
					<div class="checkbox">
						<label>
							<input type="checkbox" value="weaponLaw"> Weapon Law
						</label>
					</div>
					<div class="row category"><span>Date Range</span></div>
					<div>
						<input class="datepicker" type="text" name="daterange" value="01/01/2015 - 01/31/2015" />
					</div>
					<div class="row category"><span>Time Range</span></div>
					<div>
						<input class="datepicker" type="text" name="timerange" value="01/01/2015 0:00 AM  - 01/01/2015 11:59 PM" />
					</div>
				</form>
			</div>
			<div class="col-xs-6" id="map" style="height:450px">
			</div>
			<div class="col-xs-4" style="height: 450px">
				<div class="row" style="background-color: white; height:150px">
					<div class="col-xs-7" style="height: 30px">
					San Francisco
					<div id="zip" value="start"></div>
					</div>
					<div class="col-xs-5" id="donut" style="height: 120px;">
					</div>
				</div>
				<div class="row" style="height:150px">
						<ul class="nav nav-tabs nav-justified" style="height: 20px">
						  <li role="button" class="active"><a class="graph_tabs bar_chart">Crimes</a></li>
						  <li role="button"><a class="graph_tabs bar_chart"
class="graph_tabs">Crimes per Capita</a></li>
						</ul>
					<div class="container" id="bar" style="height: 130px"></div>
				</div>
				<div class="row" id="time_chart" style="height:150px">
						<ul class="nav nav-tabs nav-justified" style="height: 20px">
						  <li role="button" class="active"><a class="graph_tabs time_chart">Months</a></li>
						  <li role="button" ><a class="graph_tabs time_chart">Days of Week</a></li>
						  <li role="button"><a class="graph_tabs time_chart">Hours of Day</a></li>
						</ul>
					<div class="container">
					</div>
				</div>
			</div>
		</div>
	</div>
	<!-- /.container -->

	<!-- jQuery Version 1.11.1 -->
	<script src="js/jquery-1.11.3.min.js"></script>
	<script type="text/javascript" src="//cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>
	<script type="text/javascript" src="//cdn.jsdelivr.net/bootstrap.daterangepicker/2/daterangepicker.js"></script>
	<link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/bootstrap.daterangepicker/2/daterangepicker.css" />
	<!-- Bootstrap Core JavaScript -->
	<script src="js/bootstrap.min.js"></script>
	<script>

	/*
	    Global Variables
	*/
	var dateRange = ["2003/01/01", "2015/08/31"]
	var timeRange = ["12:00 AM", "11:59 PM"]
	var layers = new Array();
	layers["neighborhood"];
	var originalData = new Array();
	var checkBoxList = {"homicide": true, "sexOffense": false}
	var crimeStats = new Array();
	var population;
	var current_zip = 'city';
	var prev_zip = 'city';
	function change(){};
	/*
	    Initialization of Map Components
	*/
	var map = new L.Map("map", {center: [37.756503, -122.439788], zoom: 12, attributionControl: true});
	var SF = L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}', {
	   attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="http://mapbox.com">Mapbox</a>',
	   maxZoom: 18,
	   id: 'wentaoxu.cien3mu2z05evrskmbwjttxv8',
	   accessToken: 'pk.eyJ1Ijoid2VudGFveHUiLCJhIjoiY2llbjNtdW13MDVmMHJza20wY3B0ZnFoaCJ9.bCIlhzQz6O58tT9s0_z2Mw',
	   minZoom: 11
	}).addTo(map);
	var svg = d3.select(map.getPanes().overlayPane).append("svg"),
	g = svg.append("g").attr("class", "leaflet-zoom-hide");



	/*
	    Date Formats
	*/
	parseDate = d3.time.format("%m/%d/%Y").parse;
	formatDate = d3.time.format("%Y/%m/%d");
	parseHour = d3.time.format("%H:%M").parse;
	formatHour = d3.time.format("%H:%M");


	/*
	    Interaction Helpers
	*/
	// Initializes the daterange values and calls updateData function upon change
	$(function() {
		$('input[name="daterange"]').daterangepicker({
			autoApply: true,
			linkedCalendars: false,
			startDate: "01/01/2003",
			endDate: "08/31/2015",
			minDate: "01/01/2003",
			maxDate: "08/31/2015"
			}, 
			function(start, end) {
			updateData([start.format('YYYY/MM/DD'), end.format('YYYY/MM/DD')], timeRange);
		});
		
	});

	// Initializes the timerange values and calls updateData function upon change
	$(function() {
	$('input[name="timerange"]').daterangepicker({
		timePicker: true,
		timePickerIncrement: 1,
		autoApply: true,
		locale: {
			format: 'hh:mm A'
		},
		ranges: {
		"All Day": [
			"12:00 AM",
			"11:59 PM"
		],
		"Morning":[
			"06:00 AM",
			"11:59 AM"
		],
		"Afternoon":[
			"12:00 PM",
			"05:59 PM"
		],
		"Evening":[
			"06:00 PM",
			"11:59 PM"
		],
		"Late Night":[
			"12:00 AM",
			"05:59 AM"
		]
		},
		startDate: "12:00 AM",
		endDate: "11:59 PM",
		minDate: "12:00 AM",
		maxDate: "11:59 PM"
		},
		function(start, end){
			var start_time = new Date(start);
			var end_time = new Date(end);
			timeRange[0] = formatHour(parseHour(start_time.getHours()+":"+start_time.getMinutes()));
			timeRange[1] = formatHour(parseHour(end_time.getHours()+":"+end_time.getMinutes()));
			updateData(dateRange, timeRange);
		});
	});

	$(function(){
		$('li').click(function(){
			$(this).addClass('active').siblings().removeClass('active');
		});
	});
	/*
	    Event Handlers
	*/

	function change_tabs(){
		$(this).addClass('active').siblings().removeClass('active');
	}
	// Updates the crime layers upon changes in the checkbox values
	function update_checkbox(boolean, crime){
		if (boolean){
			checkBoxList[crime] = true;
	        map.addLayer(layers[crime]);
	        
		}
		else{
			checkBoxList[crime] = false;
	        map.removeLayer(layers[crime])
		}
	    countCrimes(originalData);
	    layers["neighborhood"].setStyle(style);
	}

	// Updates the data upon changes in datarange/timerange
	var updateData = function(date, time){
		dateRange = date;
		timeRange = time;
		var filteredData = new Array();
		for (var key in originalData){
			var result = new Array();
			for (var i = 0; i < originalData[key].features.length; i++){
				var data = originalData[key].features[i]
				if (formatDate(parseDate(data.properties.date)) >= dateRange[0] 
					&& formatDate(parseDate(data.properties.date)) <= dateRange[1]
					&& isInTimeRange(data.properties.time, time)
					){
					result.push(data)
				}
			}
			filteredData[key] = result;
		}

		d3.selectAll("input[type=checkbox]").each(function(){
			var crime = this.value;
			if(this.checked){
				map.removeLayer(layers[crime])
			}

			layers[crime] = L.geoJson(filteredData[crime], {
					pointToLayer: function(feature, latlng){
					return L.circle(latlng, 20, {className: crime});
					}
			})
			if(this.checked){
				map.addLayer(layers[crime])
			}
		})
	}

	// Helper function to ensure only the data within the selected time range is shown
	var isInTimeRange = function(time, timeRange){
		if (timeRange[0] < timeRange[1]){
			if (time >= timeRange[0] && time <= timeRange[1]){
				return true;
			}
			else return false
		}
		else{
			if (time >= timeRange[0] || time <= timeRange[1]){
				return true
			}
			else return false
		}
	}

	// Helper function to count the crime being displayed
	function countCrimes(data){
		crimeStats = {}
		for (var key in data){
			var crime = data[key].features; 
	        if(checkBoxList[key]){
				for (var i = 0; i < crime.length; i++){
					var zip = crime[i].properties.zip;
					var name = crime[i].properties.crime;
					if(zip in crimeStats){
						if (name in crimeStats[zip]){
							crimeStats[zip][name] += 1;
						}
						else{
							crimeStats[zip][name] = 1;
						}
					}
					else{
						crimeStats[zip] = {};
						crimeStats[zip][name] = 1; 
						crimeStats[zip]['total'] = 0; 
					}
					crimeStats[zip]['total'] += 1;
				}
			} 
	        else{
	        	for(var zip in population){
	        		if (zip != 'total'){
		        		if (!(zip in crimeStats)){
		        			crimeStats[zip] = {};
		        			crimeStats[zip][key] = 0;	
		        		}
		        		else{
		        			crimeStats[zip][key] = 0;		
		        		}
		        	}
	        	}
	        }
		}
		var temp = {};
		for(var zip in crimeStats){
			for(var key in crimeStats[zip]){
				if(!(key in temp)){
					temp[key] = 0  	
				}
				temp[key] += crimeStats[zip][key];
			}
		}	    
	    crimeStats['city'] = temp
	    
	}

	/*
	    Map Styles
	*/

	    function getColor(d, pop){
	    var val = (d/pop)/(crimeStats['city']['total']/population["total"])
	        return val > 4.00  ? '#084594' :
	        val > 2.00  ? '#2171b5' : 
	        val > 1.50  ? '#4292c6' :
	        val > 1.00  ? '#6baed6' :
	        val > 0.75  ? '#9ecae1' :
	        val > 0.50  ? '#c6dbef' :
	        val > 0.25  ? '#deebf7' :
	                  '#f7fbff';
	    }

	    function style(feature){
	        if (crimeStats['city']['total'] > 0){
	            return {
	                fillColor: getColor(crimeStats[feature.id]['total'], population[feature.id]),
	                weight: 2,
	                color: 'white',
	                dashArray: '',
	                }
	        }
	        else{
	            return {
	            fillColor: "#cccccc",
	            weight: 2,
	            color: 'white',
	            dashArray: '',
	            } 
	        }
	        
	    }


	/*
		Draws donut chart that shows proportion of each crime happening in the area of interest
	*/


function draw_bar(){
	var margin = {top: 5, right: 5, bottom: 5, left:30},
	height = 130 - margin.top - margin.bottom,
	width = 390 - margin.left - margin.right;
	var x = d3.scale.ordinal()
		.rangeRoundBands([0, width], .1)
	var y = d3.scale.linear()
		.rangeRound([height, 0])
	var color = d3.scale.ordinal()
    .range(["#98abc5", "#8a89a6", "#7b6888", "#6b486b", "#a05d56", "#d0743c", "#ff8c00"]);
	// var xAxis = d3.svg.axis()
 //    .scale(x)
 //    .orient("bottom");
	var yAxis = d3.svg.axis()
    .scale(y)
    .orient("left")
    .ticks(5)

   	var svg = d3.select("#bar").append("svg")
    	.attr("width", width + margin.left + margin.right)
    	.attr("height", height + margin.top + margin.bottom)
  	.append("g")
    	.attr("transform", "translate(" + margin.left + "," + margin.top + ")");
    
    var domain_keys = [];
    for(var key in crimeStats[current_zip]){
    	if(key !== 'total'){
    		domain_keys.push(key);	
    	}
    }
    color.domain(domain_keys);

    var bar_data = []
    for(var key in crimeStats){
    	if(key !== 'city' && key !== 'N/A'){
    		var datum = {"neighborhood": key, "vals": null, "total": null}
    		var y0 = 0;
    		datum.vals = color.domain().map(function(name){
    				return {name: name, y0: y0, y1: y0 += crimeStats[key][name]};
    			});
	    	datum.total = datum.vals[datum.vals.length - 1].y1;
    	bar_data.push(datum)
    	}
    }
    
    bar_data.sort(function(a, b){return b.total - a.total; })
    x.domain(bar_data.map(function(d) { return d.neighborhood; }));
    y.domain([0, d3.max(bar_data, function(d) {return d.total; })]);
    // svg.append("g")
    //   .attr("class", "x axis")
    //   .attr("transform", "translate(0," + height + ")")
    //   .call(xAxis);
	svg.append("g")
      .attr("class", "y axis")
      .call(yAxis)
      
    .append("text")
      .attr("transform", "rotate(-90)")
      .attr("y", 6)
      .attr("dy", ".71em")

    var rect = svg.selectAll(".rect")
      .data(bar_data)
    .enter().append("g")
      .attr("class", "g")
      .attr("transform", function(d) { return "translate(" + x(d.neighborhood) + ",0)"; });

  rect.selectAll("rect")
      .data(function(d) { return d.vals; })
    .enter().append("rect")
      .attr("width", x.rangeBand())
      .attr("y", function(d) { return y(d.y1); })
      .attr("height", function(d) { return y(d.y0) - y(d.y1); })
      .style("fill", function(d) { return color(d.name); });

       d3.selectAll("input")
      .on("change", function(){updateBars()});

      function updateBars(){

      	var bar_data = []
    	for(var key in crimeStats){
    	if(key !== 'city' && key !== 'N/A'){
    		var datum = {"neighborhood": key, "vals": null, "total": null}
    		var y0 = 0;
    		datum.vals = color.domain().map(function(name){
    				return {name: name, y0: y0, y1: y0 += crimeStats[key][name]};
    			});
	    	datum.total = datum.vals[datum.vals.length - 1].y1;
    		bar_data.push(datum)
    		}
    	}
        bar_data.sort(function(a, b){return b.total - a.total; })
	    y.domain([0, d3.max(bar_data, function(d) {return d.total; })]);
	    
	    var rect = svg.selectAll("rect")
	    	.data(bar_data)

	    rect.selectAll("rect")
	    	.data(function(d) { return d.vals; })
	    	.enter().append("rect")
	    	.transition()
	    	.duration(500)
	    	.attr("width", x.rangeBand())
	    	.attr("y", function(d) {return y(d.y1); })
      		.attr("height", function(d) { return y(d.y0) - y(d.y1); })
      		.style("fill", function(d) { return color(d.name); });
    }
    
}



function draw_donut(){
var width = 150,
	height = 150,
	radius = Math.min(width, height) / 2;

var color = d3.scale.category20();

var arc = d3.svg.arc()
	.outerRadius(radius - 5)
	.innerRadius(radius - 30);

var pie = d3.layout.pie()
	.sort(null)
	.value(function(d){ return d; });

var svg_donut = d3.select("#donut").append("svg")
	.attr("width", width)
	.attr("height", height)
  .append("g")
	.attr("transform", "translate(" + width / 2 + "," + height / 2 + ")")

var donut_data = [];
for(var key in crimeStats[current_zip]){
	if (key != "total"){
		donut_data.push(crimeStats[current_zip][key]);
	}
}
var path = svg_donut.datum(donut_data).selectAll("path")
	.data(pie)
  .enter().append("path")
  	.attr("fill", function(d, i){return color(i)})
   	.attr("d", arc)
   	.each(function(d) {this._current = d; }) // store the initial angles
   	.classed("donut", true);

var names = ["homicide", "sexOffense"]
path.append("text")
      .attr("transform", function(d) { return "translate(" + arc.centroid(d) + ")"; })
      .attr("dy", ".35em")
      .style("text-anchor", "middle")
      .text(function(d, i) { return "hello"; });

 d3.selectAll("input")
      .on("change", function(){change("input")});

d3.selectAll(".neighborhood")
.on("click", function(){change("click")});
  
  function change(type) {
  	if(type == "click"){
  		if(current_zip === prev_zip){
  			setTimeout(change, 10);
  			return;
  		}
  	}
    donut_data = [];
    for(var key in crimeStats[current_zip]){
    	if (key != "total"){
		donut_data.push(crimeStats[current_zip][key]);
		}
    }
    pie.value(function(d, i){return donut_data[i]; }); // change the value function
    path = path.data(pie); // compute the new angles
    path.transition().duration(750).attrTween("d", arcTween); // redraw the arcs
	prev_zip = current_zip;
  }

  function arcTween(a) {
  var i = d3.interpolate(this._current, a);
  this._current = i(0);
  return function(t) {
    return arc(i(t));
  };
}
}


	/*
	    Main function that makes the map
	*/
	function makeMyMap(error, collection, homicide, sexOffense, population_data){
	if(error){
	    throw error;
	}
	else{
		
	    //Store the data in the global array
	    originalData["homicide"] = homicide;
		originalData["sexOffense"] = sexOffense;
		population = population_data;
	    countCrimes(originalData);

		var transform = d3.geo.transform({point: projectPoint}),
			  path = d3.geo.path().projection(transform);
		  
		var feature = g.selectAll("path")
			  .data(collection.features)
			  .enter().append("path");

		map.on("viewreset", reset);
		  reset();

		// Reposition the SVG to cover the features.
		function reset() {
			var bounds = path.bounds(collection),
				topLeft = bounds[0],
				bottomRight = bounds[1];

		   svg.attr("width", bottomRight[0] - topLeft[0])
			  .attr("height", bottomRight[1] - topLeft[1])
			  .style("left", topLeft[0] + "px")
			  .style("top", topLeft[1] + "px");

			g.attr("transform", "translate(" + -topLeft[0] + "," + -topLeft[1] + ")");

			feature.attr("d", path);
		}

		 // Use Leaflet to implement a D3 geometric transformation.
		 function projectPoint(x, y) {
			var point = map.latLngToLayerPoint(new L.LatLng(y, x));
			this.stream.point(point.x, point.y);
		  }

		function highlightFeature(e){
			var layer = e.target;
			layer.setStyle({
				fillColor: '#CC0000',
				fillOpacity: 0.5
			});
		}

		function resetHighlight(e){
				layers["neighborhood"].resetStyle(e.target);
		}

		function zoomToFeature(e){
			current_zip = e.target.feature.properties.id;
			map.fitBounds(e.target.getBounds());
			d3.select("#zip").text(current_zip);
		//     console.log(e.target.feature.properties.name);
		  }

		function onEachFeature(feature, layer){
			layer.on({
				mouseover: highlightFeature,
				mouseout: resetHighlight,
				click: zoomToFeature
			});
		  }

		layers["neighborhood"] = L.geoJson(collection, {
			onEachFeature: onEachFeature, style: style, className: "neighborhood"
		  })
	      .setZIndex(0)
	      .addTo(map);

	     

	    var crime_data = {
	    	"homicide": homicide,
	    	"sexOffense": sexOffense
	    }

	    for(var key in crime_data){
	    	layers[key] = L.geoJson(crime_data[key], {
				pointToLayer: function(feature, latlng){
					return L.circle(latlng, 30, {className: key});
				}
			})
	    }

	    layers["homicide"].addTo(map);

	   draw_donut();
	   draw_bar();
	   
		// var singleStat = new Array();
	 //  	for(var key in crimeStats["94110"]){
	 //  		singleStat.push([{"crime":key}, {"stat": crimeStats["94110"][key]}]);
	 //  	}

	  	
	 	// console.log(crimeStats["94110"])

	  	// var donut_data = singleStat.map(function(d){
	  	// 	console.log(d);	
	  	// 	return {
	  	// 		crime: 1,
	  	// 		stat: 2
	  	// 	};
	  	// });

	  	// singleStat.forEach(function(d, i){
	  	// 	console.log(d[0].crime, d[1].stat);
	  	// })
	   // console.log(crimeStats["94110"])

	}};
	//Load the data
	queue()
	.defer(d3.json, "data/sf-neighborhoods.json")
	.defer(d3.json, "data/homicide.min.json")
	.defer(d3.json, "data/sexOffense.min.json")
	.defer(d3.json, "data/population.json")
	.await(makeMyMap);
	</script>
	</body>

	</html>
